!function(b){var e=function(a,c){this.element=b(a);this.options=b.extend({},b.fn.cropBox.defaults,c);if(this.element.data("size")){var d=this.element.data("size").split("x");this.options.width=parseInt(d[0]);this.options.height=parseInt(d[1])}this.element.data("size-preview")?(d=this.element.data("size-preview").split("x"),this.options.previewWidth=d[0],this.options.previewHeight=d[1]):(this.options.previewWidth=this.options.width,this.options.previewHeight=this.options.height);this.element.data("aspect")&&
(this.options.aspect=this.element.data("aspect"));this.element.data("url")&&(this.options.url=this.element.data("url"));this.options.defaultAspect=this.options.aspect+0.2;this.holder=this.build();this.toggle();this.setPosition();this.repositeSelected(100*this.options.defaultAspect);this.slider.slider("option","min",100*this.options.aspect);this.slider.slider("value",100*this.options.defaultAspect);this.slider.off("slide");this.send.off("click");this.slider.on("slide",b.proxy(this.onSlide,this));this.send.on("click",
b.proxy(this.onSend,this))};e.prototype={setPosition:function(){var a=this.element.position(),c=a.left+this.element.width()+5;c+parseInt(this.options.previewWidth)>b(document).width()&&(c=a.left-10-this.options.previewWidth);this.holder.css({left:c,top:a.top});this.area.css({width:this.options.previewWidth,height:this.options.previewHeight});this.image.css({width:this.options.previewWidth,left:0,top:0});this.image.attr("src",this.element.data("crop"))},toggle:function(){var a;this.holder.toggle();
this.holder.is(":visible")?(b(document).on("click.cropbox",b.proxy(function(){b(document).off("click.cropbox");this.toggle()},this)),a="show"):a="hide";this.element.trigger(a)},build:function(){var a;b("#crop-box").length?(a=b("#crop-box"),this.area=a.find(".b-crop-box__area"),this.image=a.find(".b-crop-box__image"),this.selected=a.find(".b-crop-box__selected"),this.masks=a.find(".b-crop-box__mask"),this.slider=a.find(".b-crop-box__slider"),this.send=a.find(".b-crop-box__send")):(a=b("<div/>",{"class":"b-crop-box",
id:"crop-box"}).hide().appendTo("body"),a.append('<div class="b-crop-box__area"><img class="b-crop-box__image"/><div class="b-crop-box__mask left"/><div class="b-crop-box__mask right"/><div class="b-crop-box__mask top"/><div class="b-crop-box__mask bottom"/><div class="b-crop-box__selected"/></div><div class="b-crop-box__panel"><div class="b-crop-box__slider b-crop-box__track"><i class="b-crop-box__track"/></div><span class="b-crop-box__send"/></div>'),a.on("click",function(a){a.stopPropagation()}),
this.masks=a.find(".b-crop-box__mask"),this.area=a.find(".b-crop-box__area"),this.image=a.find(".b-crop-box__image"),this.selected=a.find(".b-crop-box__selected"),this.send=a.find(".b-crop-box__send"),this.slider=a.find(".b-crop-box__slider"),this.addDragBehaviour(),this.slider.slider({max:100}));return a},onSend:function(){var a=b("<canvas/>").hide().appendTo("body")[0];a.width=this.options.previewWidth;a.height=this.options.previewHeight;var c=a.getContext("2d"),d=this.image.position(),e=this.selected.position(),
f=this.selected.width(),g=this.selected.height();c.drawImage(this.image[0],d.left,d.top,this.image.width(),this.image.height());c.drawImage(a,e.left,e.top,f,g,0,0,this.options.width,this.options.height);c=b("<canvas/>").hide().appendTo("body")[0];c.width=this.options.width;c.height=this.options.height;c.getContext("2d").drawImage(a,0,0,this.options.width,this.options.height,0,0,this.options.width,this.options.height);b.post(this.options.url,{cropped_file:c.toDataURL("image/png")},b.proxy(function(a){this.element.trigger("complete",
a)},this));b(c).remove();b(a).remove()},addDragBehaviour:function(){this.area.on("mousedown",b.proxy(function(a){this.area.addClass("b-crop-box__area_down");this.start={left:a.clientX-this.holder.position().left-this.image.position().left,top:a.clientY-this.holder.position().top-this.image.position().top};b(document).on("mousemove.cropbox",b.proxy(function(a){var b=a.clientX-this.start.left-this.holder.position().left,a=a.clientY-this.start.top-this.holder.position().top;this.image.css({left:b,top:a})},
this));b(document).on("mouseup.cropbox",b.proxy(function(){this.area.removeClass("b-crop-box__area_down");b(document).off("mousemove.cropbox");b(document).off("mouseup.cropbox")},this));a.preventDefault()},this))},repositeSelected:function(a){var b=Math.floor(this.options.width*a/100),a=Math.floor(this.options.height*a/100);this.selected.css({width:b,height:a,left:Math.floor(this.area.width()/2-b/2),top:Math.floor(this.area.height()/2-a/2)});this.masks.eq(0).css({left:this.selected.position().left,
top:0,width:b,height:this.selected.position().top});this.masks.eq(1).css({left:this.selected.position().left,bottom:0,width:b,height:this.selected.position().top});this.masks.eq(2).css({left:0,top:0,width:this.selected.position().left,height:"100%"});this.masks.eq(3).css({right:0,top:0,width:this.area.width()-b-this.selected.position().left,height:"100%"})},onSlide:function(a,b){this.repositeSelected(b.value)}};b.fn.cropBox=function(a){return this.each(function(){b(this).data("crop-box",new e(this,
a))})};b.fn.cropBox.defaults={width:260,height:350,aspect:0.5,url:"/crop"};b(function(){b("body").on("click","[data-crop]",function(a){b(this).cropBox({});a.stopPropagation()})})}(window.jQuery);
