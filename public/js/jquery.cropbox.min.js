!function(b){var e=function(a){this.element=b(a);this.options=b.fn.cropBox.defaults;this.element.data("size")&&(a=this.element.data("size").split("x"),this.options.width=parseInt(a[0]),this.options.height=parseInt(a[1]));this.element.data("size-preview")?(a=this.element.data("size-preview").split("x"),this.options.previewWidth=a[0],this.options.previewHeight=a[1]):(this.options.previewWidth=this.options.width,this.options.previewHeight=this.options.height);this.element.data("url")&&(this.options.url=
this.element.data("url"));this.element.data("min-aspect")&&(this.options.aspect=this.element.data("min-aspect"));this.element.data("param")&&(this.options.param=this.element.data("param"));if(this.element.data("type")&&(a=this.element.data("type"),"jpg"==a&&(a="jpeg"),"png"==a||"jpg"==a))this.options.type=a;this.build();this.toggle();this.setPosition();this.resetSliderPosition();this.repositeSelected(100*this.options.aspect);this.holder.off("slide").on("slide",b.proxy(this.onSlide,this));this.send.off("click").on("click",
b.proxy(this.onSend,this))};e.prototype={setCachedElements:function(){this.holder.data("cached",{area:this.holder.find(".b-crop-box__area"),image:this.holder.find(".b-crop-box__image"),selected:this.holder.find(".b-crop-box__selected"),masks:this.holder.find(".b-crop-box__mask"),slider:this.holder.find(".b-crop-box__slider"),knob:this.holder.find(".b-crop-box__knob"),send:this.holder.find(".b-crop-box__send")});this.getCachedElements()},getCachedElements:function(){var a=this.holder.data("cached");
b.extend(this,a)},build:function(){b("#crop-box").length?(this.holder=b("#crop-box"),this.getCachedElements()):(this.holder=b("<div/>",{"class":"b-crop-box",id:"crop-box"}).hide().appendTo("body"),this.holder.append('<div class="b-crop-box__area"><img class="b-crop-box__image"/><div class="b-crop-box__mask left"/><div class="b-crop-box__mask right"/><div class="b-crop-box__mask top"/><div class="b-crop-box__mask bottom"/><div class="b-crop-box__selected"/><div class="b-crop-box__cross"/></div><div class="b-crop-box__panel"><div class="b-crop-box__slider b-crop-box__track"><i class="b-crop-box__track"/><span class="b-crop-box__knob"/></div><span class="b-crop-box__send"/></div>'),
this.setCachedElements(),this.holder.on("click",function(a){a.stopPropagation()}),this.addDragBehaviour(),this.addSlider())},resetSliderPosition:function(){this.knob.css("left",0)},addSlider:function(){this.knob.on("mousedown",b.proxy(function(a){b(document).on("mousemove.cropbox",b.proxy(function(a){a=a.pageX-this.slider.offset().left;0>a?a=0:a>this.slider.width()&&(a=this.slider.width());this.knob.css("left",a);this.holder.trigger("slide",(100-100*this.options.aspect)/this.slider.width()*a+100*
this.options.aspect)},this));b(document).on("mouseup.cropbox",b.proxy(function(){b(document).off("mouseup.cropbox mousemove.cropbox")},this));a.preventDefault()},this))},setPosition:function(){this.area.css({width:this.options.previewWidth,height:this.options.previewHeight});this.image.css({width:this.options.previewWidth,left:0,top:0});var a=this.element.offset(),c=a.left+this.element.width()+5;c+parseInt(this.options.previewWidth)>b(document).width()&&(c=a.left-this.holder.outerWidth()-5);this.holder.css({left:c,
top:a.top});this.image.attr("src",this.element.data("crop"))},toggle:function(){var a;this.holder.toggle();this.holder.is(":visible")?(this.element.addClass("active"),b(document).on("click.cropbox",b.proxy(function(){b(document).off("click.cropbox");this.toggle()},this)),a="show"):(a="hide",this.element.removeClass("active"));this.element.trigger(a)},onSend:function(){var a=b("<canvas/>").appendTo("body")[0],c=b("<canvas/>").appendTo("body")[0],d=b("<canvas/>").appendTo("body")[0];a.width=this.options.previewWidth;
a.height=this.options.previewHeight;c.width=this.options.previewWidth;c.height=this.options.previewHeight;d.width=this.options.width;d.height=this.options.height;var f=a.getContext("2d"),e=c.getContext("2d"),i=d.getContext("2d"),g=this.image.position(),h=this.selected.position(),j=this.selected.width(),k=this.selected.height();f.drawImage(this.image[0],g.left,g.top,this.image.width(),this.image.height());e.drawImage(a,h.left,h.top,j,k,0,0,this.options.width,this.options.height);i.drawImage(c,0,0,
this.options.width,this.options.height,0,0,this.options.width,this.options.height);f=d.toDataURL("image/"+this.options.type);b([a,d,c]).remove();a={};a[this.options.param]=f;b.post(this.options.url,a).success(b.proxy(function(a){this.element.trigger("success",a)},this)).error(b.proxy(function(a){this.element.trigger("error",a)},this))},addDragBehaviour:function(){this.area.on("mousedown",b.proxy(function(a){this.area.addClass("b-crop-box__area_down");this.start={left:a.clientX-this.holder.position().left-
this.image.position().left,top:a.clientY-this.holder.position().top-this.image.position().top};b(document).on("mousemove.cropbox",b.proxy(function(a){var b=a.clientX-this.start.left-this.holder.position().left,a=a.clientY-this.start.top-this.holder.position().top;this.image.css({left:b,top:a})},this));b(document).on("mouseup.cropbox",b.proxy(function(){this.area.removeClass("b-crop-box__area_down");b(document).off("mousemove.cropbox");b(document).off("mouseup.cropbox")},this));a.preventDefault()},
this))},repositeSelected:function(a){var b=Math.floor(this.options.width*a/100),a=Math.floor(this.options.height*a/100);this.selected.css({width:b,height:a,left:Math.floor(this.area.width()/2-b/2),top:Math.floor(this.area.height()/2-a/2)});this.masks.eq(0).css({left:this.selected.position().left,top:0,width:b,height:this.selected.position().top});this.masks.eq(1).css({left:this.selected.position().left,bottom:0,width:b,height:this.selected.position().top});this.masks.eq(2).css({left:0,top:0,width:this.selected.position().left,
height:"100%"});this.masks.eq(3).css({right:0,top:0,width:this.area.width()-b-this.selected.position().left,height:"100%"})},onSlide:function(a,b){this.repositeSelected(b)}};b.fn.cropBox=function(){return b(this).data("crop-box",new e(this))};b.fn.cropBox.defaults={width:260,height:350,aspect:0.5,url:"/crop",type:"png",param:"cropped_file"};b(function(){b("body").on("click","[data-crop]",function(a){b(this).cropBox();a.stopPropagation()})})}(window.jQuery);
